<?xml version="1.0" encoding="utf-8"?>
<odoo>
    <!-- Server Action to Load Data -->
    <record id="action_load_stock_data" model="ir.actions.server">
        <field name="name">Load Stock Data</field>
        <field name="model_id" ref="model_simple_stock_report"/>
        <field name="state">code</field>
        <field name="code">
# Use the improved refresh_data method
result = model.refresh_data()

# Call the recalculate method for all records to ensure movements are calculated
records = model.search([])
for record in records:
    record.calculate_movements()

# Return to the report view
action = env.ref('slow_moving_stock_report.action_simple_stock_report').read()[0]
        </field>
    </record>

    <!-- Server Action to Recalculate Movements -->
    <record id="action_recalculate_movements" model="ir.actions.server">
        <field name="name">Recalculate Movements</field>
        <field name="model_id" ref="model_simple_stock_report"/>
        <field name="state">code</field>
        <field name="code">
# Get all existing records
records = model.search([])

# Recalculate movements for each record
for record in records:
    record.calculate_movements()

# Show notification
action = {
    'type': 'ir.actions.client',
    'tag': 'display_notification',
    'params': {
        'title': 'Success',
        'message': f'Recalculated movements for {len(records)} products',
        'type': 'success',
        'sticky': False,
    }
}
        </field>
    </record>

    <!-- List View -->
    <record id="view_simple_stock_report_list" model="ir.ui.view">
        <field name="name">simple.stock.report.list</field>
        <field name="model">simple.stock.report</field>
        <field name="arch" type="xml">
            <list string="Slow Moving Stock Report" create="0" edit="0">
                <header>
                    <button name="%(action_load_stock_data)d" type="action" string="Refresh Data" class="btn-primary" icon="fa-refresh"/>
                </header>
                <field name="product_id" widget="many2one_avatar" width="200px"/>
                <field name="default_code" optional="show" width="100px"/>
                <field name="qty_on_hand" sum="Total" width="80px"/>
                <field name="qty_30_days" string="30d Qty" decoration-danger="qty_30_days == 0" decoration-warning="qty_30_days &lt; 5" width="80px"/>
                <field name="qty_60_days" string="60d Qty" decoration-warning="qty_60_days &lt; 10" optional="show" width="80px"/>
                <field name="qty_90_days" string="90d Qty" optional="show" width="80px"/>
                <field name="turnover_30_days" string="30d %" widget="percentage" decoration-danger="turnover_30_days &lt; 0.10" decoration-warning="turnover_30_days &lt; 0.20" width="80px"/>
                <field name="turnover_60_days" string="60d %" widget="percentage" decoration-danger="turnover_60_days &lt; 0.10" decoration-warning="turnover_60_days &lt; 0.20" optional="show" width="80px"/>
                <field name="turnover_90_days" string="90d %" widget="percentage" decoration-danger="turnover_90_days &lt; 0.10" decoration-warning="turnover_90_days &lt; 0.20" optional="show" width="80px"/>
                <field name="value_on_hand" string="Value" widget="monetary" sum="Total Value" optional="show" width="100px"/>
            </list>
        </field>
    </record>

    <!-- Search View -->
    <record id="view_simple_stock_report_search" model="ir.ui.view">
        <field name="name">simple.stock.report.search</field>
        <field name="model">simple.stock.report</field>
        <field name="arch" type="xml">
            <search string="Search Slow Moving Stock">
                <field name="product_id"/>
                <field name="default_code"/>
                <field name="categ_id"/>
                <separator/>
                <filter string="No Movement (30 days)" name="no_movement_30" domain="[('qty_30_days', '=', 0)]"/>
                <separator/>
                <filter string="High Value Items" name="high_value" domain="[('value_on_hand', '&gt;', 1000)]"/>
                <filter string="Has Stock" name="has_stock" domain="[('qty_on_hand', '&gt;', 0)]"/>
                <filter string="Low Stock" name="low_stock" domain="[('qty_on_hand', '&lt;', 10)]"/>
                <group string="Group By">
                    <filter name="group_category" string="Product Category" context="{'group_by': 'categ_id'}"/>
                    <filter name="group_location" string="Location" context="{'group_by': 'location_id'}"/>
                </group>
            </search>
        </field>
    </record>

    <!-- Auto-refresh Server Action -->
    <record id="action_auto_refresh_on_open" model="ir.actions.server">
        <field name="name">Auto Refresh Data</field>
        <field name="model_id" ref="model_simple_stock_report"/>
        <field name="state">code</field>
        <field name="code">
# Auto-refresh data when page opens
model.refresh_data()

# Calculate movements for all records
records = model.search([])
for record in records:
    record.calculate_movements()

# Open the list view
action = {
    'type': 'ir.actions.act_window',
    'name': 'Slow Moving Stock Report',
    'res_model': 'simple.stock.report',
    'view_mode': 'list,form,pivot,graph',
    'domain': [],
    'context': {'search_default_has_stock': 1},
    'target': 'current',
}
        </field>
    </record>

    <!-- Action -->
    <record id="action_simple_stock_report" model="ir.actions.act_window">
        <field name="name">Slow Moving Stock Report</field>
        <field name="res_model">simple.stock.report</field>
        <field name="view_mode">list,form,pivot,graph</field>
        <field name="search_view_id" ref="view_simple_stock_report_search"/>
        <field name="context">{'search_default_has_stock': 1}</field>
        <field name="help" type="html">
            <p class="o_view_nocontent_smiling_face">
                No stock data found
            </p>
            <p>
                Click the button below to load your product stock data.
            </p>
            <p>
                <a type="action" name="%(action_load_stock_data)d" class="btn-primary">Load Stock Data</a>
            </p>
        </field>
    </record>

    <!-- Menu -->
    <menuitem id="menu_simple_stock_report"
              name="Slow Moving Stock Report"
              action="action_auto_refresh_on_open"
              parent="stock.menu_stock_inventory_control"
              sequence="60"/>
</odoo>